// evmone: Fast Ethereum Virtual Machine implementation
// Copyright 2020 The evmone Authors.
// SPDX-License-Identifier: Apache-2.0

#include "evmone/baseline.hpp"
#include "test/experimental/jumpdest_analysis.hpp"
#include "test/utils/utils.hpp"
#include <benchmark/benchmark.h>
#include <numeric>

#include <evmc/hex.hpp>
#include <cstring>
#include <iostream>


namespace
{
// blake2_shifts + weierstrudel + sha1_div.
const auto test_bytecode = *evmc::from_hex(
    "608060405234801561001057600080fd5b50600436106100365760003560e01c80631e0924231461003b578063d299"
    "dac0146102bb575b600080fd5b610282600480360360a081101561005157600080fd5b810190602081018135640100"
    "00000081111561006c57600080fd5b82018360208201111561007e57600080fd5b8035906020019184600183028401"
    "11640100000000831117156100a057600080fd5b91908080601f016020809104026020016040519081016040528093"
    "9291908181526020018383808284376000920191909152509295949360208101935035915050640100000000811115"
    "6100f357600080fd5b82018360208201111561010557600080fd5b8035906020019184600183028401116401000000"
    "008311171561012757600080fd5b91908080601f016020809104026020016040519081016040528093929190818152"
    "602001838380828437600092019190915250929594936020810193503591505064010000000081111561017a576000"
    "80fd5b82018360208201111561018c57600080fd5b8035906020019184600183028401116401000000008311171561"
    "01ae57600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380"
    "828437600092019190915250929594936020810193503591505064010000000081111561020157600080fd5b820183"
    "60208201111561021357600080fd5b8035906020019184600183028401116401000000008311171561023557600080"
    "fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600092"
    "0191909152509295505050903567ffffffffffffffff1691506103f49050565b604051808261010080838360005b83"
    "8110156102a8578181015183820152602001610290565b5050505090500191505060405180910390f35b6102826004"
    "80360360608110156102d157600080fd5b8101906020810181356401000000008111156102ec57600080fd5b820183"
    "6020820111156102fe57600080fd5b8035906020019184600183028401116401000000008311171561032057600080"
    "fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600092"
    "019190915250929594936020810193503591505064010000000081111561037357600080fd5b820183602082011115"
    "61038557600080fd5b803590602001918460018302840111640100000000831117156103a757600080fd5b91908080"
    "601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250"
    "9295505050903567ffffffffffffffff1691506104489050565b6103fc61156d565b61040461158d565b61040c6115"
    "6d565b61042982858961041b8a610485565b6104248a610485565b610538565b61043382896106dc565b61043d8282"
    "61079b565b979650505050505050565b61045061156d565b61047d8484602060405190810160405280600081525060"
    "20604051908101604052806000815250866103f4565b949350505050565b61048d6115ca565b60005b825181101561"
    "04fb5760088184018101519067ffffffffffffffff82166007841660010182026040031b9084908404600281106104"
    "c957fe5b6020020151188360088404600281106104de57fe5b67ffffffffffffffff90921660209290920201525060"
    "0101610490565b5061050d8160005b60200201516108cd565b67ffffffffffffffff16815261052481600161050356"
    "5b67ffffffffffffffff166020820152919050565b67ffffffffffffffff84161580610559575060408467ffffffff"
    "ffffffff16115b80610565575060408351115b1561056f57600080fd5b61057761156d565b50604080516101008101"
    "8252676a09e667f3bcc908815267bb67ae8584caa73b6020820152673c6ef372fe94f82b9181019190915267a54ff5"
    "3a5f1d36f1606082015267510e527fade682d16080820152679b05688c2b3e6c1f60a0820152671f83d9abfb41bd6b"
    "60c0820152675be0cd19137e217960e082015260005b600881101561063d5781816008811061060a57fe5b60200201"
    "5187602001518260088110151561062157fe5b67ffffffffffffffff90921660209290920201526001016105f5565b"
    "50835160208781018051805167ffffffffffffffff94851660081b1889186301010000188416905285518151608090"
    "81018051909218851690915286830151825160a0018051909118851690528551825160c00180519091188516905291"
    "850151905160e00180519091188316905286821690880152845190600090821611156106d3576106cb87866106dc56"
    "5b608060608801525b50505050505050565b60005b815181101561079657826060015167ffffffffffffffff166080"
    "141561074057606083015160408401805167ffffffffffffffff9092169091016fffffffffffffffffffffffffffff"
    "ffff16905261073883600061094f565b600060608401525b60608301805167ffffffffffffffff6001820181169092"
    "52166107616115e5565b508351835160009085908590811061077557fe5b90602001015160f81c60f81b60f81c9050"
    "80838301535050506001016106df565b505050565b60608201805160408401805167ffffffffffffffff8084169182"
    "016fffffffffffffffffffffffffffffffff1690925260019092011690915260006107de6115e5565b508351825b60"
    "808110156107f95782818301536001016107e3565b5061080585600161094f565b60005b6080860151600890048110"
    "1561085457602086015161082c90826008811061050357fe5b85826008811061083857fe5b67ffffffffffffffff90"
    "92166020929092020152600101610808565b506040856080015110156108c657608085015160208601516008600783"
    "16810260400392610889929190046008811061050357fe5b67ffffffffffffffff16901c8460088760800151811515"
    "6108a657fe5b04600881106108b157fe5b67ffffffffffffffff90921660209290920201525b5050505050565b6000"
    "67010000000000000060ff8316026501000000000061ff00841602630100000062ff000085160261010063ff000000"
    "861681029064ff00000000871604630100000065ff00000000008816046501000000000066ff000000000000891604"
    "67010000000000000067ff000000000000008a16041818181818181892915050565b610957611604565b61095f6116"
    "04565b61096761156d565b506040805161010081018252676a09e667f3bcc908815267bb67ae8584caa73b60208201"
    "52673c6ef372fe94f82b9181019190915267a54ff53a5f1d36f1606082015267510e527fade682d16080820152679b"
    "05688c2b3e6c1f60a0820152671f83d9abfb41bd6b60c0820152675be0cd19137e217960e082015260005b60088110"
    "15610a5f57602086015181600881106109fe57fe5b6020020151848260108110610a0f57fe5b67ffffffffffffffff"
    "9092166020929092020152818160088110610a2f57fe5b6020020151846008830160108110610a4357fe5b67ffffff"
    "ffffffffff90921660209290920201526001016109e5565b506040850180516101808501805167ffffffffffffffff"
    "928316188216905290516101a085018051680100000000000000006fffffffffffffffffffffffffffffffff909316"
    "9290920490911890911690528315610acc576101c0830180511967ffffffffffffffff1690525b600080805b601081"
    "60ff161015610b56576000925060038116801515610b0c578851600460ff84160460ff16600481101515610b0457fe"
    "5b602002015192505b67ffffffffffffffff83826003036040021c169350610b2a846108cd565b8660ff8416601081"
    "10610b3957fe5b67ffffffffffffffff909216602092909202015250600101610ad1565b50610b7985600060046008"
    "600c89845b60200201518a60015b60200201516113e8565b610b9685600160056009600d8960025b60200201518a60"
    "03610b6f565b610bb38560026006600a600e8960045b60200201518a6005610b6f565b610bd08560036007600b600f"
    "8960065b60200201518a6007610b6f565b610bed8560006005600a600f8960085b60200201518a6009610b6f565b61"
    "0c0a8560016006600b600c89600a5b60200201518a600b610b6f565b610c2785600260076008600d89600c5b602002"
    "01518a600d610b6f565b610c4385600360046009600e89815b60200201518a600f610b6f565b610c60856000600460"
    "08600c89600e5b60200201518a600a610b6f565b610c7d85600160056009600d8960045b60200201518a6008610b6f"
    "565b610c918560026006600a600e896009610c36565b610cae8560036007600b600f89600d5b60200201518a600661"
    "0b6f565b610ccb8560006005600a600f8960015b60200201518a600c610b6f565b610ce88560016006600b600c8960"
    "005b60200201518a6002610b6f565b610cfc85600260076008600d89600b610bc3565b610d1085600360046009600e"
    "896005610b89565b610d2485600060046008600c89600b610c70565b610d4185600160056009600d89600c5b602002"
    "01518a6000610b6f565b610d558560026006600a600e896005610cdb565b610d688560036007600b600f8981610c1a"
    "565b610d848560006005600a600f89825b60200201518a600e610b6f565b610d988560016006600b600c896003610c"
    "a1565b610dab85600260076008600d8983610b66565b610dc785600360046009600e89825b60200201518a6004610b"
    "6f565b610ddb85600060046008600c896007610be0565b610def85600160056009600d896003610b66565b610e0385"
    "60026006600a600e89600d610cbe565b610e168560036007600b600f8982610d77565b610e2a8560006005600a600f"
    "896002610ca1565b610e3e8560016006600b600c896005610c53565b610e5285600260076008600d896004610d3456"
    "5b610e6685600360046009600e89600f610c70565b610e7a85600060046008600c896009610d34565b610e8d856001"
    "60056009600d8983610bc3565b610ea08560026006600a600e8984610dba565b610eb48560036007600b600f89600a"
    "610c36565b610ec88560006005600a600f89600e610b66565b610edb8560016006600b600c8982610cbe565b610eef"
    "85600260076008600d896006610c70565b610f0285600360046009600e8984610c1a565b610f168560006004600860"
    "0c896002610cbe565b610f2a85600160056009600d896006610c53565b610f3e8560026006600a600e896000610bfd"
    "565b610f528560036007600b600f896008610b89565b610f668560006005600a600f896004610c1a565b610f7a8560"
    "016006600b600c896007610ba6565b610f8e85600260076008600d89600f610d77565b610fa285600360046009600e"
    "896001610be0565b610fb585600060046008600c8981610ba6565b610fc885600160056009600d8984610c36565b61"
    "0fdb8560026006600a600e8981610c1a565b610fef8560036007600b600f896004610c53565b611002856000600560"
    "0a600f8984610bc3565b6110158560016006600b600c8983610b89565b61102985600260076008600d896009610cdb"
    "565b61103d85600360046009600e896008610bfd565b61105185600060046008600c89600d610bfd565b6110658560"
    "0160056009600d896007610d77565b6110798560026006600a600e89600c610b66565b61108c8560036007600b600f"
    "8984610be0565b61109f8560006005600a600f8983610d34565b6110b38560016006600b600c89600f610dba565b61"
    "10c685600260076008600d8982610ca1565b6110da85600360046009600e896002610c53565b6110ee856000600460"
    "08600c896006610c36565b61110285600160056009600d89600e610be0565b6111168560026006600a600e89600b61"
    "0b89565b61112a8560036007600b600f896000610c70565b61113e8560006005600a600f89600c610cdb565b611152"
    "8560016006600b600c89600d610bc3565b61116685600260076008600d896001610dba565b61117a85600360046009"
    "600e89600a610ba6565b61118e85600060046008600c89600a610cdb565b6111a285600160056009600d896008610d"
    "ba565b6111b68560026006600a600e896007610ca1565b6111ca8560036007600b600f896001610ba6565b6111dd85"
    "60006005600a600f8981610bfd565b6111f18560016006600b600c896009610d77565b61120585600260076008600d"
    "896003610cbe565b61121985600360046009600e89600d610d34565b61122c85600060046008600c8984610b66565b"
    "61124085600160056009600d896002610b89565b6112548560026006600a600e896004610ba6565b61126885600360"
    "07600b600f896006610bc3565b61127c8560006005600a600f896008610be0565b6112908560016006600b600c8960"
    "0a610bfd565b6112a485600260076008600d89600c610c1a565b6112b785600360046009600e8981610c36565b6112"
    "cb85600060046008600c89600e610c53565b6112df85600160056009600d896004610c70565b6112f3856002600660"
    "0a600e896009610c36565b6113078560036007600b600f89600d610ca1565b61131b8560006005600a600f89600161"
    "0cbe565b61132f8560016006600b600c896000610cdb565b61134385600260076008600d89600b610bc3565b611357"
    "85600360046009600e896005610b89565b60005b60088160ff1610156113de578560ff600883011660108110611378"
    "57fe5b60200201518660ff83166010811061138c57fe5b602002015189602001518360ff166008811015156113a657"
    "fe5b6020020151181888602001518260ff166008811015156113c257fe5b67ffffffffffffffff9092166020929092"
    "02015260010161135a565b5050505050505050565b60008787601081106113f657fe5b602002015190506000888760"
    "10811061140b57fe5b60200201519050600089876010811061142057fe5b6020020151905060008a87601081106114"
    "3557fe5b6020020151905068010000000000000000868486010893508318602081811c91901b67ffffffffffffffff"
    "161868010000000000000000818308915067ffffffffffffffff82841860281b1682841860181c1892506801000000"
    "0000000000858486010893508318601081901c60309190911b67ffffffffffffffff16186801000000000000000081"
    "8308928318603f81901c60019190911b67ffffffffffffffff1618929150838b8b601081106114e957fe5b67ffffff"
    "ffffffffff9092166020929092020152828b8a6010811061150a57fe5b67ffffffffffffffff909216602092909202"
    "0152818b896010811061152b57fe5b67ffffffffffffffff9092166020929092020152808b886010811061154c57fe"
    "5b67ffffffffffffffff90921660209290920201525050505050505050505050565b61010060405190810160405280"
    "6008906020820280388339509192915050565b6101e0604051908101604052806115a26115e5565b81526020016115"
    "af61156d565b81526000602082018190526040820181905260609091015290565b6040805180820182529060029082"
    "9080388339509192915050565b6080604051908101604052806004906020820280388339509192915050565b610200"
    "60405190810160405280601090602082028038833950919291505056fea165627a7a72305820a59dc9d098d29bacdd"
    "88cb50c25c96ed4ba3047fd46a5c6ecf57e447a3c699100029"
    "346060600036030617156100195761019060005260206000fd5b6060600036030460021b603e016102006136c66000"
    "396004810281600302826005020182601e018103838203848203858203868203878203888203606060003603048080"
    "01600a1b60e0019060061b6000015b60017f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f0"
    "0000018235067f30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f000000190067f30644e72e1"
    "31a029b85045b68181585d2833e84879b9709143e1f593f000000180807fffffffffffffffffffffffffffffffffff"
    "ffffffffffffffffffffffffffffff70024ccef014a773d2cf7a7bd9d4391eb18d850970024ccef014a773d2cf7a7b"
    "d9d4391eb18d85028082109103036789d3256894d213e3097f30644e72e131a029b85045b68181585d2833e84879b9"
    "709143e1f593f00000017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff6802d91d"
    "232ec7e0b3d786096802d91d232ec7e0b3d786028082109103037f30644e72e131a029b85045b68181585cb8e665ff"
    "8b011694c1d039a872b0eed9090891818377b3c4d79d41a917585bfc41088d8daaa78b17ea66b99c90dd090860051b"
    "9060051b5b937ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc0001938e6005026060"
    "600036030461080002610200010390806101e01651565b908e019060041c806101e01651565b8060031c6103e01686"
    "01828f019283516002018085528f03015260081c601001806101e01651565b8060021c6103e0168601828d01928351"
    "6002018085528d03015260071c601001806101e01651565b8060011c6103e0168601828b019283516002018085528b"
    "03015260061c601001806101e01651565b806103e01686018289019283516002018085528903015260051c60100180"
    "6101e01651565b601f811161021b57509060018303926101da5750505060200180360361006c575050505050505050"
    "5050506000037f912CEB58A394E07D28F0D12384840918C6843FB439555FA7B461A4448976F7D57f60C89CE5C26340"
    "5370A08B6D0302B0BB2F02D522D0E3951A7841182DB0F9FA8E7f30644E72E131A029B85045B68181585D97816A9168"
    "71CA8D3C208C16D87CFD477759e26bcea0d48bacd4f263f1acdb5c4f5763473177fffffe60c0528260a05281608052"
    "6000604003600360003603048001038060605280359060200135828080848009840960030883828009146103b65761"
    "019060005260206000fd5b82818009838160021b818080838809968009600302818180098783038001018a03806000"
    "528701099209840380019180016040528101602052826020518201600051840182808280098061040a5760006000fd"
    "5b818184099382828909830383808084800983800101880891820181930982878a09018b03829561052a565b604060"
    "6051036060528084808083800980930981606051358190066060516020013582900682808084800984096003088382"
    "80091461047a5761019060005260206000fd5b9409920985818009868160021b818082870981038187800960030290"
    "82828009818001018060a051036000520109920980010160a051036020528583800182098060405290919286808084"
    "8009938409948309878094860984038492838180098480808385096020510984019160005109840185808280098061"
    "04fd5760006000fd5b818184099382828909830383808084800983800101880891820181930982878a090160805103"
    "8280968199095b83818009848080838509602051098401916000510984018580828009806105515760006000fd5b81"
    "8184099382828909830383808084800983800101880891820181930982878a09016080510382809681990983818009"
    "848080838509602051098401916000510984018580828009806105a45760006000fd5b818184099382828909830383"
    "808084800983800101880891820181930982878a090160805103828096819909838180098480808385096020510984"
    "01916000510984018580828009806105f75760006000fd5b8181840993828289098303838080848009838001018808"
    "91820181930982878a0901608051038280968199098381800984808083850960205109840191600051098401858082"
    "80098061064a5760006000fd5b818184099382828909830383808084800983800101880891820181930982878a0901"
    "60805103828096819909838180098480808385096020510984019160005109840185808280098061069d5760006000"
    "fd5b818184099382828909830383808084800983800101880891820181930982878a09016080510382809681990983"
    "818009848080838509602051098401916000510984018580828009806106f05760006000fd5b818184099382828909"
    "830383808084800983800101880891820181930982878a09016080510382808097819a096040510960006060510361"
    "0435573d526001600160606000360304600f036101cd0261074501565b91849083098061732052806176e052840380"
    "6172e0526177205291839083098303838160c05109806176c05261770052806172c052617300529209930993840980"
    "61736052806176a0528203806172a0526177605292830983038360c051820980617680526177405280617280526173"
    "405292099309938409806173a0528061766052820380617260526177a05292830983038360c0518209806176405261"
    "77805280617240526173805292099309938409806173e0528061762052820380617220526177e05292830983038360"
    "c051820980617600526177c05280617200526173c052920993099384098061742052806175e0528203806171e05261"
    "78205292830983038360c0518209806175c05261780052806171c05261740052920993099384098061746052806175"
    "a0528203806171a0526178605292830983038360c05182098061758052617840528061718052617440529209930993"
    "8409806174a0528061756052820380617160526178a05292830983038360c051820980617540526178805280617140"
    "526174805292099309938409806174e0528061752052820380617120526178e05292830985038560c0518209806175"
    "00526178c05280617100526174c052920992095b918490830980616b205280616ee052840380616ae052616f205291"
    "839083098303838160c0510980616ec052616f005280616ac052616b00529209930993840980616b605280616ea052"
    "820380616aa052616f605292830983038360c051820980616e8052616f405280616a8052616b405292099309938409"
    "80616ba05280616e6052820380616a6052616fa05292830983038360c051820980616e4052616f805280616a405261"
    "6b80529209930993840980616be05280616e2052820380616a2052616fe05292830983038360c051820980616e0052"
    "616fc05280616a0052616bc0529209930993840980616c205280616de0528203806169e05261702052928309830383"
    "60c051820980616dc05261700052806169c052616c00529209930993840980616c605280616da0528203806169a052"
    "6170605292830983038360c051820980616d8052617040528061698052616c40529209930993840980616ca0528061"
    "6d6052820380616960526170a05292830983038360c051820980616d4052617080528061694052616c805292099309"
    "93840980616ce05280616d2052820380616920526170e05292830985038560c051820980616d00526170c052806169"
    "0052616cc052920992095b91849083098061632052806166e0528403806162e0526167205291839083098303838160"
    "c05109806166c05261670052806162c05261630052920993099384098061636052806166a0528203806162a0526167"
    "605292830983038360c051820980616680526167405280616280526163405292099309938409806163a05280616660"
    "52820380616260526167a05292830983038360c0518209806166405261678052806162405261638052920993099384"
    "09806163e0528061662052820380616220526167e05292830983038360c051820980616600526167c0528061620052"
    "6163c052920993099384098061642052806165e0528203806161e0526168205292830983038360c0518209806165c0"
    "5261680052806161c05261640052920993099384098061646052806165a0528203806161a052616860529283098303"
    "8360c051820980616580526168405280616180526164405292099309938409806164a0528061656052820380616160"
    "526168a05292830983038360c051820980616540526168805280616140526164805292099309938409806164e05280"
    "61652052820380616120526168e05292830985038560c051820980616500526168c05280616100526164c052920992"
    "095b918490830980615b205280615ee052840380615ae052615f205291839083098303838160c0510980615ec05261"
    "5f005280615ac052615b00529209930993840980615b605280615ea052820380615aa052615f605292830983038360"
    "c051820980615e8052615f405280615a8052615b40529209930993840980615ba05280615e6052820380615a605261"
    "5fa05292830983038360c051820980615e4052615f805280615a4052615b80529209930993840980615be05280615e"
    "2052820380615a2052615fe05292830983038360c051820980615e0052615fc05280615a0052615bc0529209930993"
    "840980615c205280615de0528203806159e0526160205292830983038360c051820980615dc05261600052806159c0"
    "52615c00529209930993840980615c605280615da0528203806159a0526160605292830983038360c051820980615d"
    "8052616040528061598052615c40529209930993840980615ca05280615d6052820380615960526160a05292830983"
    "038360c051820980615d4052616080528061594052615c80529209930993840980615ce05280615d20528203806159"
    "20526160e05292830985038560c051820980615d00526160c0528061590052615cc052920992095b91849083098061"
    "532052806156e0528403806152e0526157205291839083098303838160c05109806156c05261570052806152c05261"
    "530052920993099384098061536052806156a0528203806152a0526157605292830983038360c05182098061568052"
    "6157405280615280526153405292099309938409806153a0528061566052820380615260526157a052928309830383"
    "60c051820980615640526157805280615240526153805292099309938409806153e052806156205282038061522052"
    "6157e05292830983038360c051820980615600526157c05280615200526153c0529209930993840980615420528061"
    "55e0528203806151e0526158205292830983038360c0518209806155c05261580052806151c0526154005292099309"
    "9384098061546052806155a0528203806151a0526158605292830983038360c0518209806155805261584052806151"
    "80526154405292099309938409806154a0528061556052820380615160526158a05292830983038360c05182098061"
    "5540526158805280615140526154805292099309938409806154e0528061552052820380615120526158e052928309"
    "85038560c051820980615500526158c05280615100526154c052920992095b918490830980614b205280614ee05284"
    "0380614ae052614f205291839083098303838160c0510980614ec052614f005280614ac052614b0052920993099384"
    "0980614b605280614ea052820380614aa052614f605292830983038360c051820980614e8052614f405280614a8052"
    "614b40529209930993840980614ba05280614e6052820380614a6052614fa05292830983038360c051820980614e40"
    "52614f805280614a4052614b80529209930993840980614be05280614e2052820380614a2052614fe0529283098303"
    "8360c051820980614e0052614fc05280614a0052614bc0529209930993840980614c205280614de0528203806149e0"
    "526150205292830983038360c051820980614dc05261500052806149c052614c00529209930993840980614c605280"
    "614da0528203806149a0526150605292830983038360c051820980614d8052615040528061498052614c4052920993"
    "0993840980614ca05280614d6052820380614960526150a05292830983038360c051820980614d4052615080528061"
    "494052614c80529209930993840980614ce05280614d2052820380614920526150e05292830985038560c051820980"
    "614d00526150c0528061490052614cc052920992095b91849083098061432052806146e0528403806142e052614720"
    "5291839083098303838160c05109806146c05261470052806142c05261430052920993099384098061436052806146"
    "a0528203806142a0526147605292830983038360c05182098061468052614740528061428052614340529209930993"
    "8409806143a0528061466052820380614260526147a05292830983038360c051820980614640526147805280614240"
    "526143805292099309938409806143e0528061462052820380614220526147e05292830983038360c0518209806146"
    "00526147c05280614200526143c052920993099384098061442052806145e0528203806141e0526148205292830983"
    "038360c0518209806145c05261480052806141c05261440052920993099384098061446052806145a0528203806141"
    "a0526148605292830983038360c051820980614580526148405280614180526144405292099309938409806144a052"
    "8061456052820380614160526148a05292830983038360c05182098061454052614880528061414052614480529209"
    "9309938409806144e0528061452052820380614120526148e05292830985038560c051820980614500526148c05280"
    "614100526144c052920992095b918490830980613b205280613ee052840380613ae052613f20529183908309830383"
    "8160c0510980613ec052613f005280613ac052613b00529209930993840980613b605280613ea052820380613aa052"
    "613f605292830983038360c051820980613e8052613f405280613a8052613b40529209930993840980613ba0528061"
    "3e6052820380613a6052613fa05292830983038360c051820980613e4052613f805280613a4052613b805292099309"
    "93840980613be05280613e2052820380613a2052613fe05292830983038360c051820980613e0052613fc05280613a"
    "0052613bc0529209930993840980613c205280613de0528203806139e0526140205292830983038360c05182098061"
    "3dc05261400052806139c052613c00529209930993840980613c605280613da0528203806139a05261406052928309"
    "83038360c051820980613d8052614040528061398052613c40529209930993840980613ca05280613d605282038061"
    "3960526140a05292830983038360c051820980613d4052614080528061394052613c80529209930993840980613ce0"
    "5280613d2052820380613920526140e05292830985038560c051820980613d00526140c0528061390052613cc05292"
    "0992095b91849083098061332052806136e0528403806132e0526137205291839083098303838160c05109806136c0"
    "5261370052806132c05261330052920993099384098061336052806136a0528203806132a052613760529283098303"
    "8360c051820980613680526137405280613280526133405292099309938409806133a0528061366052820380613260"
    "526137a05292830983038360c051820980613640526137805280613240526133805292099309938409806133e05280"
    "61362052820380613220526137e05292830983038360c051820980613600526137c05280613200526133c052920993"
    "099384098061342052806135e0528203806131e0526138205292830983038360c0518209806135c052613800528061"
    "31c05261340052920993099384098061346052806135a0528203806131a0526138605292830983038360c051820980"
    "613580526138405280613180526134405292099309938409806134a0528061356052820380613160526138a0529283"
    "0983038360c051820980613540526138805280613140526134805292099309938409806134e0528061352052820380"
    "613120526138e05292830985038560c051820980613500526138c05280613100526134c052920992095b9184908309"
    "80612b205280612ee052840380612ae052612f205291839083098303838160c0510980612ec052612f005280612ac0"
    "52612b00529209930993840980612b605280612ea052820380612aa052612f605292830983038360c051820980612e"
    "8052612f405280612a8052612b40529209930993840980612ba05280612e6052820380612a6052612fa05292830983"
    "038360c051820980612e4052612f805280612a4052612b80529209930993840980612be05280612e2052820380612a"
    "2052612fe05292830983038360c051820980612e0052612fc05280612a0052612bc0529209930993840980612c2052"
    "80612de0528203806129e0526130205292830983038360c051820980612dc05261300052806129c052612c00529209"
    "930993840980612c605280612da0528203806129a0526130605292830983038360c051820980612d80526130405280"
    "61298052612c40529209930993840980612ca05280612d6052820380612960526130a05292830983038360c0518209"
    "80612d4052613080528061294052612c80529209930993840980612ce05280612d2052820380612920526130e05292"
    "830985038560c051820980612d00526130c0528061290052612cc052920992095b91849083098061232052806126e0"
    "528403806122e0526127205291839083098303838160c05109806126c05261270052806122c0526123005292099309"
    "9384098061236052806126a0528203806122a0526127605292830983038360c0518209806126805261274052806122"
    "80526123405292099309938409806123a0528061266052820380612260526127a05292830983038360c05182098061"
    "2640526127805280612240526123805292099309938409806123e0528061262052820380612220526127e052928309"
    "83038360c051820980612600526127c05280612200526123c052920993099384098061242052806125e05282038061"
    "21e0526128205292830983038360c0518209806125c05261280052806121c052612400529209930993840980612460"
    "52806125a0528203806121a0526128605292830983038360c051820980612580526128405280612180526124405292"
    "099309938409806124a0528061256052820380612160526128a05292830983038360c0518209806125405261288052"
    "80612140526124805292099309938409806124e0528061252052820380612120526128e05292830985038560c05182"
    "0980612500526128c05280612100526124c052920992095b918490830980611b205280611ee052840380611ae05261"
    "1f205291839083098303838160c0510980611ec052611f005280611ac052611b00529209930993840980611b605280"
    "611ea052820380611aa052611f605292830983038360c051820980611e8052611f405280611a8052611b4052920993"
    "0993840980611ba05280611e6052820380611a6052611fa05292830983038360c051820980611e4052611f80528061"
    "1a4052611b80529209930993840980611be05280611e2052820380611a2052611fe05292830983038360c051820980"
    "611e0052611fc05280611a0052611bc0529209930993840980611c205280611de0528203806119e052612020529283"
    "0983038360c051820980611dc05261200052806119c052611c00529209930993840980611c605280611da052820380"
    "6119a0526120605292830983038360c051820980611d8052612040528061198052611c40529209930993840980611c"
    "a05280611d6052820380611960526120a05292830983038360c051820980611d4052612080528061194052611c8052"
    "9209930993840980611ce05280611d2052820380611920526120e05292830985038560c051820980611d00526120c0"
    "528061190052611cc052920992095b91849083098061132052806116e0528403806112e05261172052918390830983"
    "03838160c05109806116c05261170052806112c05261130052920993099384098061136052806116a0528203806112"
    "a0526117605292830983038360c051820980611680526117405280611280526113405292099309938409806113a052"
    "8061166052820380611260526117a05292830983038360c05182098061164052611780528061124052611380529209"
    "9309938409806113e0528061162052820380611220526117e05292830983038360c051820980611600526117c05280"
    "611200526113c052920993099384098061142052806115e0528203806111e0526118205292830983038360c0518209"
    "806115c05261180052806111c05261140052920993099384098061146052806115a0528203806111a0526118605292"
    "830983038360c051820980611580526118405280611180526114405292099309938409806114a05280611560528203"
    "80611160526118a05292830983038360c0518209806115405261188052806111405261148052920993099384098061"
    "14e0528061152052820380611120526118e05292830985038560c051820980611500526118c05280611100526114c0"
    "52920992095b918490830980610b205280610ee052840380610ae052610f205291839083098303838160c051098061"
    "0ec052610f005280610ac052610b00529209930993840980610b605280610ea052820380610aa052610f6052928309"
    "83038360c051820980610e8052610f405280610a8052610b40529209930993840980610ba05280610e605282038061"
    "0a6052610fa05292830983038360c051820980610e4052610f805280610a4052610b80529209930993840980610be0"
    "5280610e2052820380610a2052610fe05292830983038360c051820980610e0052610fc05280610a0052610bc05292"
    "09930993840980610c205280610de0528203806109e0526110205292830983038360c051820980610dc05261100052"
    "806109c052610c00529209930993840980610c605280610da0528203806109a0526110605292830983038360c05182"
    "0980610d8052611040528061098052610c40529209930993840980610ca05280610d6052820380610960526110a052"
    "92830983038360c051820980610d4052611080528061094052610c80529209930993840980610ce05280610d205282"
    "0380610920526110e05292830985038560c051820980610d00526110c0528061090052610cc052920992095b918490"
    "83098061032052806106e0528403806102e0526107205291839083098303838160c05109806106c052610700528061"
    "02c05261030052920993099384098061036052806106a0528203806102a0526107605292830983038360c051820980"
    "610680526107405280610280526103405292099309938409806103a0528061066052820380610260526107a0529283"
    "0983038360c051820980610640526107805280610240526103805292099309938409806103e0528061062052820380"
    "610220526107e05292830983038360c051820980610600526107c05280610200526103c05292099309938409806104"
    "2052806105e0528203806101e0526108205292830983038360c0518209806105c05261080052806101c05261040052"
    "920993099384098061046052806105a0528203806101a0526108605292830983038360c05182098061058052610840"
    "5280610180526104405292099309938409806104a0528061056052820380610160526108a05292830983038360c051"
    "820980610540526108805280610140526104805298090981038160c051820980610500526108c05280610100526104"
    "c052930909806104e0528061052052810380610120526108e0523d518460071b606060003603046108000261020001"
    "035b850180511561225657607c6138c6601e3980518103601e870301516202ffe01680518403906020015184036001"
    "60606000360304610800026102000151603e01606060003603046108000261020001526002848a019451035161ffff"
    "16565b858082800981605a8703516202ffe01680602001518286850983910986019282915109860181808083800981"
    "84820999098103968189818780098a800101089809940993850109018603905b85808280098160588703516202ffe0"
    "168060200151828685098391098601928291510986018180808380098184820999098103968189818780098a800101"
    "089809940993850109018603905b85808280098160568703516202ffe0168060200151828685098391098601928291"
    "510986018180808380098184820999098103968189818780098a800101089809940993850109018603905b85808280"
    "098160548703516202ffe0168060200151828685098391098601928291510986018180808380098184820999098103"
    "968189818780098a800101089809940993850109018603905b85808280098160528703516202ffe016806020015182"
    "8685098391098601928291510986018180808380098184820999098103968189818780098a80010108980994099385"
    "0109018603905b85808280098160508703516202ffe016806020015182868509839109860192829151098601818080"
    "8380098184820999098103968189818780098a800101089809940993850109018603905b858082800981604e870351"
    "6202ffe016806020015182868509839109860192829151098601818080838009818482099909810396818981878009"
    "8a800101089809940993850109018603905b858082800981604c8703516202ffe01680602001518286850983910986"
    "01928291510986018180808380098184820999098103968189818780098a800101089809940993850109018603905b"
    "858082800981604a8703516202ffe01680602001518286850983910986019282915109860181808083800981848209"
    "99098103968189818780098a800101089809940993850109018603905b85808280098160488703516202ffe0168060"
    "200151828685098391098601928291510986018180808380098184820999098103968189818780098a800101089809"
    "940993850109018603905b85808280098160468703516202ffe0168060200151828685098391098601928291510986"
    "018180808380098184820999098103968189818780098a800101089809940993850109018603905b85808280098160"
    "448703516202ffe0168060200151828685098391098601928291510986018180808380098184820999098103968189"
    "818780098a800101089809940993850109018603905b85808280098160428703516202ffe016806020015182868509"
    "8391098601928291510986018180808380098184820999098103968189818780098a80010108980994099385010901"
    "8603905b85808280098160408703516202ffe016806020015182868509839109860192829151098601818080838009"
    "8184820999098103968189818780098a800101089809940993850109018603905b858082800981603e8703516202ff"
    "e0168060200151828685098391098601928291510986018180808380098184820999098103968189818780098a8001"
    "01089809940993850109018603905b858082800981603c8703516202ffe01680602001518286850983910986019282"
    "91510986018180808380098184820999098103968189818780098a800101089809940993850109018603905b858082"
    "800981603a8703516202ffe01680602001518286850983910986019282915109860181808083800981848209990981"
    "03968189818780098a800101089809940993850109018603905b85808280098160388703516202ffe0168060200151"
    "828685098391098601928291510986018180808380098184820999098103968189818780098a800101089809940993"
    "850109018603905b85808280098160368703516202ffe0168060200151828685098391098601928291510986018180"
    "808380098184820999098103968189818780098a800101089809940993850109018603905b85808280098160348703"
    "516202ffe0168060200151828685098391098601928291510986018180808380098184820999098103968189818780"
    "098a800101089809940993850109018603905b85808280098160328703516202ffe016806020015182868509839109"
    "8601928291510986018180808380098184820999098103968189818780098a80010108980994099385010901860390"
    "5b85808280098160308703516202ffe016806020015182868509839109860192829151098601818080838009818482"
    "0999098103968189818780098a800101089809940993850109018603905b858082800981602e8703516202ffe01680"
    "60200151828685098391098601928291510986018180808380098184820999098103968189818780098a8001010898"
    "09940993850109018603905b858082800981602c8703516202ffe01680602001518286850983910986019282915109"
    "86018180808380098184820999098103968189818780098a800101089809940993850109018603905b858082800981"
    "602a8703516202ffe01680602001518286850983910986019282915109860181808083800981848209990981039681"
    "89818780098a800101089809940993850109018603905b85808280098160288703516202ffe0168060200151828685"
    "098391098601928291510986018180808380098184820999098103968189818780098a800101089809940993850109"
    "018603905b85808280098160268703516202ffe0168060200151828685098391098601928291510986018180808380"
    "098184820999098103968189818780098a800101089809940993850109018603905b85808280098160248703516202"
    "ffe0168060200151828685098391098601928291510986018180808380098184820999098103968189818780098a80"
    "0101089809940993850109018603905b85808280098160228703516202ffe016806020015182868509839109860192"
    "8291510986018180808380098184820999098103968189818780098a800101089809940993850109018603905b8580"
    "8280098160208703516202ffe016806020015182868509839109860192829151098601818080838009818482099909"
    "8103968189818780098a800101089809940993850109018603905b8582800192830986818001818080838909810397"
    "800960030281818009888001019788010992090191869109850388840193515161ffff16565b858082800981605a87"
    "03516202ffe01680602001518286850983910986019282915109860181808083800981848209990981039681898187"
    "80098a800101089809940993850109018603905b85808280098160588703516202ffe0168060200151828685098391"
    "098601928291510986018180808380098184820999098103968189818780098a800101089809940993850109018603"
    "905b85808280098160568703516202ffe0168060200151828685098391098601928291510986018180808380098184"
    "820999098103968189818780098a800101089809940993850109018603905b85808280098160548703516202ffe016"
    "8060200151828685098391098601928291510986018180808380098184820999098103968189818780098a80010108"
    "9809940993850109018603905b85808280098160528703516202ffe016806020015182868509839109860192829151"
    "0986018180808380098184820999098103968189818780098a800101089809940993850109018603905b8580828009"
    "8160508703516202ffe016806020015182868509839109860192829151098601818080838009818482099909810396"
    "8189818780098a800101089809940993850109018603905b858082800981604e8703516202ffe01680602001518286"
    "85098391098601928291510986018180808380098184820999098103968189818780098a8001010898099409938501"
    "09018603905b858082800981604c8703516202ffe01680602001518286850983910986019282915109860181808083"
    "80098184820999098103968189818780098a800101089809940993850109018603905b858082800981604a87035162"
    "02ffe0168060200151828685098391098601928291510986018180808380098184820999098103968189818780098a"
    "800101089809940993850109018603905b85808280098160488703516202ffe0168060200151828685098391098601"
    "928291510986018180808380098184820999098103968189818780098a800101089809940993850109018603905b85"
    "808280098160468703516202ffe0168060200151828685098391098601928291510986018180808380098184820999"
    "098103968189818780098a800101089809940993850109018603905b85808280098160448703516202ffe016806020"
    "0151828685098391098601928291510986018180808380098184820999098103968189818780098a80010108980994"
    "0993850109018603905b85808280098160428703516202ffe016806020015182868509839109860192829151098601"
    "8180808380098184820999098103968189818780098a800101089809940993850109018603905b8580828009816040"
    "8703516202ffe016806020015182868509839109860192829151098601818080838009818482099909810396818981"
    "8780098a800101089809940993850109018603905b858082800981603e8703516202ffe01680602001518286850983"
    "91098601928291510986018180808380098184820999098103968189818780098a8001010898099409938501090186"
    "03905b858082800981603c8703516202ffe01680602001518286850983910986019282915109860181808083800981"
    "84820999098103968189818780098a800101089809940993850109018603905b858082800981603a8703516202ffe0"
    "168060200151828685098391098601928291510986018180808380098184820999098103968189818780098a800101"
    "089809940993850109018603905b85808280098160388703516202ffe0168060200151828685098391098601928291"
    "510986018180808380098184820999098103968189818780098a800101089809940993850109018603905b85808280"
    "098160368703516202ffe0168060200151828685098391098601928291510986018180808380098184820999098103"
    "968189818780098a800101089809940993850109018603905b85808280098160348703516202ffe016806020015182"
    "8685098391098601928291510986018180808380098184820999098103968189818780098a80010108980994099385"
    "0109018603905b85808280098160328703516202ffe016806020015182868509839109860192829151098601818080"
    "8380098184820999098103968189818780098a800101089809940993850109018603905b8580828009816030870351"
    "6202ffe016806020015182868509839109860192829151098601818080838009818482099909810396818981878009"
    "8a800101089809940993850109018603905b858082800981602e8703516202ffe01680602001518286850983910986"
    "01928291510986018180808380098184820999098103968189818780098a800101089809940993850109018603905b"
    "858082800981602c8703516202ffe01680602001518286850983910986019282915109860181808083800981848209"
    "99098103968189818780098a800101089809940993850109018603905b858082800981602a8703516202ffe0168060"
    "200151828685098391098601928291510986018180808380098184820999098103968189818780098a800101089809"
    "940993850109018603905b85808280098160288703516202ffe0168060200151828685098391098601928291510986"
    "018180808380098184820999098103968189818780098a800101089809940993850109018603905b85808280098160"
    "268703516202ffe0168060200151828685098391098601928291510986018180808380098184820999098103968189"
    "818780098a800101089809940993850109018603905b85808280098160248703516202ffe016806020015182868509"
    "8391098601928291510986018180808380098184820999098103968189818780098a80010108980994099385010901"
    "8603905b85808280098160228703516202ffe016806020015182868509839109860192829151098601818080838009"
    "8184820999098103968189818780098a800101089809940993850109018603905b85808280098160208703516202ff"
    "e0168060200151828685098391098601928291510986018180808380098184820999098103968189818780098a8001"
    "01089809940993850109018603905b806136a757505050508460071b606060003603046108000261020001035b8501"
    "8051156134dd57603e6060600036030461080002610200015103606060003603046108000261020001528051810360"
    "1e870301516202ffe0168051840390602001518403600160028451038452835161353757613627565b858082800981"
    "86516002810388528703601e8d0301516202ffe0168060200151828685098391098601928291510986018180808380"
    "09806135ff57876135a8575050505086516002810388528703601e8d0301516202ffe0168060200151820395505190"
    "0394505050506001613620565b818680096135ea575050505050505085828001928309868180018180808389098103"
    "978009600302818180098880010197880109920901918691098503613620565b505050505050505050506000600160"
    "00613620565b8184820999098103968189818780098a800101089809940993850109018603905b8351613537575b83"
    "6060600036030461080002610200011461367a57858280019283098681800181808083890981039780096003028181"
    "800988800101978801099209019186910985039288019283511561362757613537565b806136a75780158260011484"
    "1516166136935760006000fd5b60405260205260005250505050505060603df35b8486910960405284900684036020"
    "528390063d5250505050505060603df300000000000000000000000000000000000000000000000000000000000002"
    "c700000000000000000000000000000000000000000000000000000000000002a20000000000000000000000000000"
    "00000000000000000000000000000000027a0000000000000000000000000000000000000000000000000000000000"
    "0002a20000000000000000000000000000000000000000000000000000000000000252000000000000000000000000"
    "00000000000000000000000000000000000002a2000000000000000000000000000000000000000000000000000000"
    "000000027a00000000000000000000000000000000000000000000000000000000000002a200000000000000000000"
    "0000000000000000000000000000000000000000022a00000000000000000000000000000000000000000000000000"
    "000000000002a2000000000000000000000000000000000000000000000000000000000000027a0000000000000000"
    "0000000000000000000000000000000000000000000002a20000000000000000000000000000000000000000000000"
    "00000000000000025200000000000000000000000000000000000000000000000000000000000002a2000000000000"
    "000000000000000000000000000000000000000000000000027a000000000000000000000000000000000000000000"
    "00000000000000000002a22b9d2b512b052ab92a6d2a2129d52989293d28f128a52859280d27c12775272926dd2691"
    "264525f925ad2561251524c9247d243123e52399234d230122b534bf3473342733db338f334332f732ab325f321331"
    "c7317b312f30e33097304b2fff2fb32f672f1b2ecf2e832e372deb2d9f2d532d072cbb2c6f2c232bd7"
    "608060405234801561001057600080fd5b5060043610610047577c0100000000000000000000000000000000000000"
    "00000000000000000060003504631605782b811461004c575b600080fd5b6100f26004803603602081101561006257"
    "600080fd5b81019060208101813564010000000081111561007d57600080fd5b82018360208201111561008f576000"
    "80fd5b803590602001918460018302840111640100000000831117156100b157600080fd5b91908080601f01602080"
    "9104026020016040519081016040528093929190818152602001838380828437600092019190915250929550610127"
    "945050505050565b604080517fffffffffffffffffffffffffffffffffffffffff0000000000000000000000009092"
    "168252519081900360200190f35b60006040518251602084019350604067ffffffffffffffc0600183011601600982"
    "820310600181146101585761015f565b6040820191505b50776745230100efcdab890098badcfe001032547600c3d2"
    "e1f06101d0565b6000838310156101c9575080820151928290039260208410156101c9577fffffffffffffffffffff"
    "ffffffffffffffffffffffffffffffffffffffffffff60208590036101000a0119165b9392505050565b60005b8281"
    "1015610686576101e684828961017e565b85526101f684602083018961017e565b6020860152604081850310600181"
    "1461020e57610217565b60808286038701535b506040830381146001811461022b57610239565b6020860180516008"
    "87021790525b5060405b6080811015610339578581017fffffffffffffffffffffffffffffffffffffffffffffffff"
    "ffffffffffffffc08101517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc8820151"
    "7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe08301517fffffffffffffffffffff"
    "fffffffffffffffffffffffffffffffffffffffffff48401516002911891909218189081027ffffffffefffffffeff"
    "fffffefffffffefffffffefffffffefffffffefffffffe1663800000009091047c0100000001000000010000000100"
    "00000100000001000000010000000116179052600c0161023d565b5060805b61014081101561043a578581017fffff"
    "ffffffffffffffffffffffffffffffffffffffffffffffffffffffffff808101517fffffffffffffffffffffffffff"
    "ffffffffffffffffffffffffffffffffffff908201517fffffffffffffffffffffffffffffffffffffffffffffffff"
    "ffffffffffffffc08301517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe8840151"
    "6004911891909218189081027ffffffffcfffffffcfffffffcfffffffcfffffffcfffffffcfffffffcfffffffc1663"
    "400000009091047c03000000030000000300000003000000030000000300000003000000031617905260180161033d"
    "565b508160008060005b605081101561065c5760148104801561047257600181146104ae57600281146104e8576003"
    "81146105275761055d565b6501000000000085046a0100000000000000000000860481186f01000000000000000000"
    "000000000000870416189350635a827999925061055d565b6501000000000085046f01000000000000000000000000"
    "00000086046a0100000000000000000000870418189350636ed9eba1925061055d565b6a0100000000000000000000"
    "85046f010000000000000000000000000000008604818117650100000000008804169116179350638f1bbcdc925061"
    "055d565b6501000000000085046f0100000000000000000000000000000086046a0100000000000000000000870418"
    "18935063ca62c1d692505b50601f770800000000000000000000000000000000000000000000008504168063ffffff"
    "e073080000000000000000000000000000000000000087041617905080840190508063ffffffff8616019050808301"
    "9050807c0100000000000000000000000000000000000000000000000000000000600484028c015104019050740100"
    "0000000000000000000000000000000000000081026501000000000086041794506a0100000000000000000000633f"
    "ffffff6a040000000000000000000087041663c00000006604000000000000880416170277ffffffff00ffffffff00"
    "0000000000ffffffff00ffffffff861617945050600181019050610442565b5050509190910177ffffffff00ffffff"
    "ff00ffffffff00ffffffff00ffffffff16906040016101d3565b506c0100000000000000000000000063ffffffff82"
    "1667ffffffff000000006101008404166bffffffff0000000000000000620100008504166fffffffff000000000000"
    "000000000000630100000086041673ffffffff00000000000000000000000000000000640100000000870416171717"
    "170294505050505091905056fea165627a7a7230582083396642a98f6018c81ca24dc0c2af8e842bd33a6b8d7f0863"
    "2dc1bc372e466a0029");

enum : uint8_t
{
    OP_JUMPDEST = 0x5b,
    OP_PUSH1 = 0x60,
    OP_PUSH32 = 0x7f,
};

[[gnu::noinline]] auto build_bitset2(const uint8_t* code, size_t code_size)
{
    evmone::experimental::JumpdestMap m(code_size);
    for (size_t i = 0; i < code_size; ++i)
    {
        const auto op = code[i];
        if (op == OP_JUMPDEST)
            m[i] = true;

        if ((op >> 5) == 0b11)
            i += static_cast<size_t>((op & 0b11111) + 1);
    }
    return m;
}

[[gnu::noinline]] auto build_vec(const uint8_t* code, size_t code_size)
{
    std::vector<bool> m(code_size);
    for (size_t i = 0; i < code_size; ++i)
    {
        const auto op = code[i];
        if (__builtin_expect(op == OP_JUMPDEST, false))
            m[i] = true;
        else if (op >= OP_PUSH1 && op <= OP_PUSH32)
            i += static_cast<size_t>(op - OP_PUSH1 + 1);
    }
    return m;
}

inline bool is_push(uint8_t op)
{
    //    return op >= OP_PUSH1 && op <= OP_PUSH32;
    // return (op >> 5) == 0b11;
    return (op & uint8_t{0b11100000}) == 0b01100000;
}

[[maybe_unused]] bool x = []() noexcept {
    size_t last_push = size_t(-1);
    std::vector<int> dists;
    for (size_t i = 0; i < test_bytecode.size();)
    {
        const auto op = test_bytecode[i];

        if (is_push(op))
        {
            if (last_push != size_t(-1))
                dists.push_back(static_cast<int>(i - last_push));
            last_push = i;
        }

        i += is_push(op) ? static_cast<size_t>(op - OP_PUSH1 + 2) : 1;
    }

    auto sum = std::accumulate(dists.begin(), dists.end(), 0);
    std::sort(dists.begin(), dists.end());

    std::cerr << "AVG: " << double(sum) / double(dists.size()) << "\n";
    std::cerr << "MED: " << dists[dists.size() / 2] << "\n";

    int last = 0;
    int count = 0;
    for (auto d : dists)
    {
        if (d == last)
            ++count;
        else
        {
            std::cerr << last << " x" << count << "\n";
            count = 1;
            last = d;
        }
    }
    return true;
}();

// uint8_t get_push_size(uint8_t x)
//{
//    return (x & 0b11111);
//}

[[gnu::noinline]] auto build_vec3(const uint8_t* code, size_t code_size)
{
    std::vector<bool> m(code_size);
    for (size_t i = 0; i < code_size;)
    {
        const auto op = code[i];
        if (__builtin_expect(op == OP_JUMPDEST, false))
            m[i] = true;

        i += is_push(op) ? static_cast<size_t>(op - OP_PUSH1 + 2) : 1;
    }
    return m;
}

[[gnu::noinline]] auto build_vec4(const uint8_t* code, size_t code_size)
{
    std::vector<bool> m(code_size);
    const auto code_beg = code;
    const auto code_end = code + code_size;
    for (; code < code_end; ++code)
    {
        const auto op = *code;
        if (__builtin_expect(op == OP_JUMPDEST, false))
            m[size_t(code - code_beg)] = true;
        else if (is_push(op))
            code += static_cast<size_t>(op - OP_PUSH1 + 1);
    }
    return m;
}

[[gnu::noinline]] auto build_vec5(const uint8_t* code, size_t code_size)
{
    std::vector<bool> m(code_size);
    for (size_t i = 0; i < code_size; ++i)
    {
        const auto op = code[i];
        const auto s = size_t(op - OP_PUSH1);
        if (__builtin_expect(op == OP_JUMPDEST, false))
            m[i] = true;
        else if (s <= 31)
            i += s + 1;
    }
    return m;
}

[[gnu::noinline]] auto build_vec6(const uint8_t* code, size_t code_size)
{
    std::vector<bool> m(code_size);
    for (size_t i = 0; i < code_size;)
    {
        const auto op = code[i];
        const auto s = size_t(op - OP_PUSH1);
        if (__builtin_expect(op == OP_JUMPDEST, false))
            m[i] = true;

        i += (s <= 31) ? s + 1 : 1;
    }
    return m;
}

[[gnu::noinline]] auto build_vec7(const uint8_t* code, size_t code_size)
{
    std::vector<bool> m(code_size);
    for (size_t i = 0; i < code_size;)
    {
        const auto op = code[i];
        const auto s = size_t(op - OP_PUSH1);
        if (__builtin_expect(op == OP_JUMPDEST, false))
            m[i] = true;

        const auto a = (s <= 31) ? s : 0;

        i += a + 1;
    }
    return m;
}

[[gnu::noinline]] auto build_bytes(const uint8_t* code, size_t code_size)
{
    std::vector<uint8_t> m(code_size);
    for (size_t i = 0; i < code_size; ++i)
    {
        const auto op = code[i];
        if (__builtin_expect(op == OP_JUMPDEST, false))
            m[i] = true;
        else if (op >= OP_PUSH1 && op <= OP_PUSH32)
            i += static_cast<size_t>(op - OP_PUSH1 + 1);
    }
    return m;
}

[[gnu::noinline]] auto build_shadow_code2p(const uint8_t* code, size_t code_size)
{
    std::unique_ptr<uint8_t[]> m{new uint8_t[code_size + 32]};
    long push_data = 0;
    auto p = m.get();
    const auto end = p + code_size;
    while (p != end)
    {
        const auto op = *code;
        *p = push_data <= 0 ? op : 0;
        --push_data;
        if (op >= OP_PUSH1 && op <= OP_PUSH32)
            push_data = op - OP_PUSH1 + 1;
        ++p;
        ++code;
    }
    return m;
}

[[gnu::noinline]] auto build_shadow_code3p(const uint8_t* code, size_t code_size)
{
    std::unique_ptr<uint8_t[]> m{new uint8_t[code_size + 32]};
    std::memcpy(m.get(), code, code_size);
    auto p = m.get();
    const auto end = p + code_size;
    while (p < end)
    {
        const auto op = *p++;
        if ((op >> 5) == 0b11)
        {
            const size_t s = (op & 0b11111);
            std::memset(p, 0, s + 1);
            p += s;
        }
    }
    return m;
}

[[gnu::noinline]] auto build_shadow_code4(const uint8_t* code, size_t code_size)
{
    std::unique_ptr<uint8_t[]> m{new uint8_t[code_size + 33]};
    std::memcpy(m.get(), code, code_size);
    long push_data = 0;
    for (size_t i = 0; i < code_size; ++i)
    {
        const auto op = m[i];
        bool is_push_data = push_data > 0;
        --push_data;
        if (!is_push_data && (op >> 5) == 0b11)
        {
            push_data = op - OP_PUSH1 + 1;
        }
        else if (is_push_data && op == OP_JUMPDEST)
        {
            m[i] = 0;
        }
    }
    return m;
}

[[gnu::noinline]] auto copy_by1(const uint8_t* code, size_t code_size)
{
    std::unique_ptr<uint8_t[]> m{new uint8_t[code_size + 32]};
    for (size_t i = 0; i < code_size; ++i)
    {
        const auto op = code[i];
        m[i] = op;
    }
    return m;
}

#pragma GCC push_options
#pragma GCC optimize("no-tree-loop-distribute-patterns")
[[gnu::noinline]] auto copy_by1p(const uint8_t* code, size_t code_size)
{
    std::unique_ptr<uint8_t[]> m{new uint8_t[code_size + 32]};
    auto p = m.get();
    const auto end = p + code_size;
    while (p != end)
        *p++ = *code++;
    return m;
}
#pragma GCC pop_options

[[gnu::noinline]] auto memcpy(const uint8_t* code, size_t code_size)
{
    std::unique_ptr<uint8_t[]> m{new uint8_t[code_size]};
    std::memcpy(m.get(), code, code_size);
    return m;
}

template <typename MapT, MapT Fn(const uint8_t*, size_t)>
void build_jumpdest(benchmark::State& state)
{
    for (auto _ : state)
    {
        auto r = Fn(test_bytecode.data(), test_bytecode.size());
        benchmark::DoNotOptimize(r);
    }

    using namespace benchmark;
    state.counters["bytes"] = {
        static_cast<double>(static_cast<IterationCount>(test_bytecode.size()) * state.iterations()),
        Counter::kIsRate};
}
}  // namespace

BENCHMARK_TEMPLATE(build_jumpdest, evmone::experimental::JumpdestMap,
    evmone::experimental::official_analyze_jumpdests);
BENCHMARK_TEMPLATE(build_jumpdest, evmone::experimental::JumpdestMap,
    evmone::experimental::build_jumpdest_map_bitset1);
BENCHMARK_TEMPLATE(build_jumpdest, evmone::experimental::JumpdestMap, build_bitset2);
BENCHMARK_TEMPLATE(build_jumpdest, std::vector<bool>, build_vec);
BENCHMARK_TEMPLATE(
    build_jumpdest, std::vector<bool>, evmone::experimental::build_jumpdest_map_vec1);
BENCHMARK_TEMPLATE(
    build_jumpdest, std::vector<bool>, evmone::experimental::build_jumpdest_map_vec2);
BENCHMARK_TEMPLATE(
    build_jumpdest, std::vector<bool>, evmone::experimental::build_jumpdest_map_vec3);
BENCHMARK_TEMPLATE(
    build_jumpdest, std::vector<bool>, evmone::experimental::build_jumpdest_map_sttni);
BENCHMARK_TEMPLATE(
    build_jumpdest, std::vector<bool>, evmone::experimental::build_jumpdest_map_str_avx2);
BENCHMARK_TEMPLATE(
    build_jumpdest, std::vector<bool>, evmone::experimental::build_jumpdest_map_str_avx2_mask);
BENCHMARK_TEMPLATE(
    build_jumpdest, std::vector<bool>, evmone::experimental::build_jumpdest_map_str_avx2_mask2);
BENCHMARK_TEMPLATE(
    build_jumpdest, evmone::experimental::bitset32, evmone::experimental::build_jumpdest_map_simd1);
BENCHMARK_TEMPLATE(
    build_jumpdest, evmone::experimental::bitset32, evmone::experimental::build_jumpdest_map_simd2);
BENCHMARK_TEMPLATE(build_jumpdest, std::vector<bool>, build_vec3);
BENCHMARK_TEMPLATE(build_jumpdest, std::vector<bool>, build_vec4);
BENCHMARK_TEMPLATE(build_jumpdest, std::vector<bool>, build_vec5);
BENCHMARK_TEMPLATE(build_jumpdest, std::vector<bool>, build_vec6);
BENCHMARK_TEMPLATE(build_jumpdest, std::vector<bool>, build_vec7);
BENCHMARK_TEMPLATE(build_jumpdest, std::vector<uint8_t>, build_bytes);
BENCHMARK_TEMPLATE(
    build_jumpdest, std::unique_ptr<uint8_t[]>, evmone::experimental::build_internal_code_v1);
BENCHMARK_TEMPLATE(
    build_jumpdest, std::unique_ptr<uint8_t[]>, evmone::experimental::build_internal_code_v2);
BENCHMARK_TEMPLATE(
    build_jumpdest, std::unique_ptr<uint8_t[]>, evmone::experimental::build_internal_code_v3);
BENCHMARK_TEMPLATE(
    build_jumpdest, std::unique_ptr<uint8_t[]>, evmone::experimental::build_internal_code_v4);
BENCHMARK_TEMPLATE(
    build_jumpdest, std::unique_ptr<uint8_t[]>, evmone::experimental::build_internal_code_v8);
BENCHMARK_TEMPLATE(build_jumpdest, std::unique_ptr<uint8_t[]>, build_shadow_code2p);
BENCHMARK_TEMPLATE(build_jumpdest, std::unique_ptr<uint8_t[]>, build_shadow_code3p);
BENCHMARK_TEMPLATE(build_jumpdest, std::unique_ptr<uint8_t[]>, build_shadow_code4);
BENCHMARK_TEMPLATE(build_jumpdest, std::unique_ptr<uint8_t[]>, copy_by1);
BENCHMARK_TEMPLATE(build_jumpdest, std::unique_ptr<uint8_t[]>, copy_by1p);
BENCHMARK_TEMPLATE(build_jumpdest, std::unique_ptr<uint8_t[]>, memcpy);
